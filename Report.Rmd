---
title: "Homework"
author: "Lluis Ramon"
date: "20 de abril de 2015"
output:
  pdf_document:
    fig_caption: yes
    number_sections: yes
header-includes: \usepackage{float}
---

```{r initial_chunk, echo = FALSE, warning = FALSE, message = FALSE}
library("knitr")
library("ggplot2")
library("xtable")
library("dplyr")
library("nlme")
library("gridExtra")
opts_chunk$set(echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE)

options("xtable.comment" = FALSE)
```

```{r import_dataset}
# Import dataset ----------------------------------------------------------
cows <- read.table("data/cattle_mes dades.txt", header = TRUE, 
                   sep = "\t", dec = ",", na.strings = "")

names(cows) <- c("id", "dose", "pcv", "time", "nbirth")
cows$dose <- factor(cows$dose, levels = c("L", "M", "H"))
cows$pcv.b <- as.numeric(cows$pcv > 20)
cows$pcv.f <- factor(cows$pcv > 20, labels = c("Unhealthy", "Healthy"))
cows$time.f <- paste("Time", cows$time)
cows.com <- na.omit(cows)
cows.com$idDose <- as.factor(paste(cows.com$id, cows.com$dose, sep = "_"))
```


# Introduction

Cattle are an important economic resource and also a major health factor in many countries. Therefore preventing diseases in a herd is vital. 

In this study we focus our interest on the parasite of trypanosomosis which can lead to the death of a cow. This disease, transmitted by the tsetse flies, causes an infection characterized by fever, loss of appetite and anemia, which can lead to death depending on different factors.

One medicine, the Berenil, is used to cure the infected cattle. The aim of this research is to determine the efficiency of different doses of Berenil. Finding the most efficient dose, if such a dose exists, is critical when it comes to save both cattle and money. Here lies all the interest of our study. 

To determine if a cow is ill or not a binary variable will be studied. This indicator can be 1 for a healthy cow or 0 for a sick one.


# Objective

The aim of this study is to assess the efficacy of different doses of Berenil in cattle infected with the trypanosomosis parasite.


# Dataset

A cohort of 10 different cows infected by trypanosomosis parasite was selected for the study. Each  Berenil dose (low, medium and high) was administrated three times (time 1, 2 or 3) for each animal. PCV was reported each time as well as the number of calves it had before being infected.

The variables reported for this study are presented below.

* Id: Each cow has its own id. From 1 to 10. _(id)_
* PCV: Binary variable. _(pcv.b)_
* Dose: H High, M Medium L low. _(dose)_
* Time: From 1 to 3. _(time)_
* Number of birth: From 2 to 8. _(nbirth)_

Since the gathering process of the data was unknown, several assumptions were needed.

* Each time PCV is obtained before the treatment. Therefore the effect of the third dose could not be evaluated.
* Dose is assigned randomly in time to the cow.
* For a given cow, the previous treatments (high, medium or low) do not affect the following ones.
* Time intervals are the same and fixed.


# Outcome categorization

TODO(Mathieu): Improve text

The binary response was related with a cow being healthy or unhealthy. Taking this into considertation, the outcome was categorized using the following criteria:

* [Literature review][]*: A healthy cow is estimated to have a PCV value ranging from 24 to 46.
* Practical Modeling: As the binary response should be modeled in following sections, a suitable one was searched. To this end, a trial and error with a cutoff ranging from 20 to 24 was explored.

The threshold between healthy and unhelathy cow was set at a PCV value of 20. If the PCV value was bigger it was categorized as healthy, if it was lower or equal it was cathegorized as unhelathy.

Table \ref{table:freqs} shows a contingence table for the dichotomised response variable. Healthy category increases in time while unhealthy category decreases. A Missing value category for healthy/unhealthy cow i is also included. It can be seen that the number of missng values increases with time. This topic will be studied in further detail in section \ref{sec:Missing_data_analysis} Missing Data Analysis.

```{r outcome_categorization, results='asis'}
table_pcv_time <- table(cows$pcv.f , cows$time.f, useNA = "ifany")
rownames(table_pcv_time)[3] <- "Missing value"
taula <- xtable(table_pcv_time,
                caption="Contingence table for the dichotomised response variable (rows) and times.",
                label="table:freqs",
                digits=0)
print(taula, table.placement = "H")
````

[Literature review]:http://research.vet.upenn.edu/Dairy/ClinicalPathology/tabid/3848/Default.aspx



# Statistical methods

The methods used in the statistical analyses are detailed in this section. First a Generalized Estimating Equations (GEE) and latter a Generalized Linear Mixed Model. An exploratory data analysis was performed before those regression methods.

## GEE
\label{subsec:method_GEE}

The response variable was the binary PCV to detect healthy and unhelathy cows. As we wanted to estimate the effect of dose in healthy/unhelathy cows, these two variables were included in the model.

From this initial model, a forward step-wise method was carried for the model selection, including additional covariates or interactions between them. The models were compared quasilikelihood ratio test when nested and with QuasiLikelihood Information Criteria (Pan 2001) when non-nested.

A classification table with predicted values and original data was created to asses how the model performed.

## GLMM

TODO(Mathieu)

IN order to take into account the specific effect due to the cow itself we had to introduce random effects in our model. To do that we performed a Generalised Linear Mixed Model. We kept the fixed effects found in the previous part and add random effects on the intercept and the time. Since we have two way of grouping our data we have a random effect for the id and among the values of a given cow we have random effects for the kind of dose that was used. 


## Transition Models

TODO(Lluis): Add model information.
TODO(All): Include pros/cons with our data. Decide if our data could be modeled using this kinds of models.

# Results

## GEE 

TODO(Lluis)

As explained in the section \ref{subsec:method_GEE}, a starting model for PCV was fitted with dose.  


logit(p) = beta dose + beta time



Table X shows estimates for the selected model.

```{r}
# geeglm(formula = pcv.b ~ dose + time, family = binomial, data = cows.com, 
#     id = idDose, corstr = "ar1", scale.fix = TRUE)
# 
#  Coefficients:
#             Estimate Std.err  Wald Pr(>|W|)    
# (Intercept)   -8.523   1.798 22.48  2.1e-06 ***
# doseM          1.199   1.222  0.96   0.3266    
# doseH          3.382   1.187  8.11   0.0044 ** 
# time           3.205   0.629 25.97  3.5e-07 ***
# ---
# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# 
# Scale is fixed.
# 
# Correlation: Structure = ar1  Link = identity 
# 
# Estimated Correlation Parameters:
#       Estimate Std.err
# alpha    0.171  0.0413
# Number of clusters:   29   Maximum cluster size: 3 
```


Table X shows classification table for the choosed model.

```{r classifcation_GEE}
#           Original data
#               0  1
# Prediccted 0 41  5
# Prediccted 1  4 26
```


## Random effects model

TODO(Mathieu)

# Missing Data Analysis

TODO(Gerard): Missing exploration, in processs

\label{sec:Missing_data_analysis}

In this section, the patterns of missing data will be discussed and analyzed, in order to assess its influence in the analyses performed in previous sections.

Figure \ref{fig:nabars} and Table \ref{taula:nas} show the missing data distribution over time and for each dose. Clearly, the fact that an observation is missing is associated with the dose and the time (fisher tests p-values= 0.005 and 0.007, respectively). Actually, there are more missings in low and medium dose than in high dose, and also, there are more missings as time increases.

```{r nabars, fig.height=3, fig.width=5, fig.cap="Percentage of missings for each time and dose with respect to the whole sample. \\label{fig:nabars}"}
par(cex=0.8)
a <- barplot(table(is.na(cows$pcv.f), paste(cows$dose, cows$time, sep="_"))[2,c(4:9, 1:3)]/nrow(cows)*100, beside=T, space=c(0,0,0,1,0,0,1,0,0), xaxt="n", ylab="%")
abline(h=0)
axis(1, at=a[c(2,5,8),], paste("Dose", levels(cows$dose)), tick=F, line=1.5)
axis(1, at=a, rep(paste("T", 1:3, sep=""),3), tick=F, line=-0.5)
```

```{r taula:nas, results='asis'}
tau <- xtable(aggregate(is.na(cows$pcv.f), list(Time=cows$time, Dose=cows$dose), sum)[,c(2,1,3)],
              caption="Number of missings in the outcome.",
              label="taula:nas")
print(tau, comment=F, include.rownames=F)
```


# Limitations and Further research

* Jacknife estimators for small sample better than sandwhich estimator

> Jackknife variance estimators are preferable to the sandwich estimator in case of a small number of clusters. (Højsgaard, Halekoh, Yan 2006)

* Compre a new factor L and M dose against H dose
* Perfect Separation Problem with gee

> It apeared when using a 22 PCV value threshold for healthy or unhealthy cow.

* Compare GEE model with GLMM. Coeficients and SE.

# Bibliography

TODO(Gerard): Normalize citations

* [Pan 2001, Biometrics, Akaike's Information Criterion in Generalized Estimating Equations.][]
* [Højsgaard, S., Halekoh, U. & Yan J. (2006) The R Package geepack for Generalized Estimating Equations Journal of Statistical Software, 15, 2, pp1--11][]
* [Hardin & Hilbe 2002, Generalized Estimating Equations][]
* Kamil Bartoń (2015). MuMIn: Multi-Model Inference. R package version 1.13.4.
  http://CRAN.R-project.org/package=MuMIn

[Pan 2001, Biometrics, Akaike's Information Criterion in Generalized Estimating Equations.]: http://www.jstor.org/stable/2676849?seq=2#references_tab_contents
[Højsgaard, S., Halekoh, U. & Yan J. (2006) The R Package geepack for Generalized Estimating Equations Journal of Statistical Software, 15, 2, pp1--11]: http://www.jstatsoft.org/v15/i02/paper
[Hardin & Hilbe 2002, Generalized Estimating Equations]: http://books.google.es/books/about/Generalized_Estimating_Equations.html?id=wxl7ajq8ymYC&redir_esc=y