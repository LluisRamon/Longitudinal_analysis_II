---
title: "Homework"
author: "Lluis Ramon"
date: "20 de abril de 2015"
output:
  pdf_document:
    fig_caption: yes
    number_sections: yes
header-includes: \usepackage{float}
---

```{r initial_chunk, echo = FALSE, warning = FALSE, message = FALSE}
library("knitr")
library("ggplot2")
library("xtable")
library("dplyr")
library("nlme")
library("gridExtra")
library("lme4")
library("xtable")
opts_chunk$set(echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE)

options("xtable.comment" = FALSE)
```

```{r import_dataset}
# Import dataset ----------------------------------------------------------
cows <- read.table("data/cattle_mes dades.txt", header = TRUE, 
                   sep = "\t", dec = ",", na.strings = "")

names(cows) <- c("id", "dose", "pcv", "time", "nbirth")
cows$dose <- factor(cows$dose, levels = c("L", "M", "H"))
cows$pcv.b <- as.numeric(cows$pcv > 20)
cows$pcv.f <- factor(cows$pcv > 20, labels = c("Unhealthy", "Healthy"))
cows$time.f <- paste("Time", cows$time)
cows.com <- na.omit(cows)
cows.com$idDose <- as.factor(paste(cows.com$id, cows.com$dose, sep = "_"))
```


# Introduction

Cattle are an important economic resource and also a major health factor in many countries. Therefore preventing diseases in a herd is vital. 

In this study we focus our interest on the parasite of trypanosomosis which can lead to the death of a cow. This disease, transmitted by the tsetse flies, causes an infection characterized by fever, loss of appetite and anemia, which can lead to death depending on different factors.

One medicine, the Berenil, is used to cure the infected cattle. The aim of this research is to determine the efficiency of different doses of Berenil. Finding the most efficient dose, if such a dose exists, is critical when it comes to save both cattle and money. Here lies all the interest of our study. 

To determine if a cow is ill or not a binary variable will be studied. This indicator can be 1 for a healthy cow or 0 for a sick one.


# Objective

The aim of this study is to assess the efficacy of different doses of Berenil in cattle infected with the trypanosomosis parasite.


# Dataset

A cohort of 10 different cows infected by trypanosomosis parasite was selected for the study. Each  Berenil dose (low, medium and high) was administrated three times (time 1, 2 or 3) for each animal. PCV was reported each time as well as the number of calves it had before being infected.

The variables reported for this study are presented below.

* Id: Each cow has its own id. From 1 to 10. _(id)_
* PCV: Binary variable. _(pcv.b)_
* Dose: H High, M Medium L low. _(dose)_
* Time: From 1 to 3. _(time)_
* Number of birth: From 2 to 8. _(nbirth)_

Since the gathering process of the data was unknown, several assumptions were needed.

* Each time PCV is obtained before the treatment. Therefore the effect of the third dose could not be evaluated.
* Dose is assigned randomly in time to the cow.
* For a given cow, the previous treatments (high, medium or low) do not affect the following ones.
* Time intervals are the same and fixed.


# Outcome categorization

TODO(Mathieu): Improve text

The binary response was related with a cow being healthy or unhealthy. Taking this into considertation, the outcome was categorized using the following criteria:

* [Literature review][]*: A healthy cow is estimated to have a PCV value ranging from 24 to 46.
* Practical Modeling: As the binary response should be modeled in following sections, a suitable one was searched. To this end, a trial and error with a cutoff ranging from 20 to 24 was explored.

The threshold between healthy and unhelathy cow was set at a PCV value of 20. If the PCV value was bigger it was categorized as healthy, if it was lower or equal it was cathegorized as unhelathy.

Table \ref{table:freqs} shows a contingence table for the dichotomised response variable. Healthy category increases in time while unhealthy category decreases. A Missing value category for healthy/unhealthy cow i is also included. It can be seen that the number of missng values increases with time. This topic will be studied in further detail in section \ref{sec:Missing_data_analysis} Missing Data Analysis.

```{r outcome_categorization, results='asis'}
table_pcv_time <- table(cows$pcv.f , cows$time.f, useNA = "ifany")
rownames(table_pcv_time)[3] <- "Missing value"
taula <- xtable(table_pcv_time,
                caption="Contingence table for the dichotomised response variable (rows) and times.",
                label="table:freqs",
                digits=0)
print(taula, table.placement = "H")
````

[Literature review]:http://research.vet.upenn.edu/Dairy/ClinicalPathology/tabid/3848/Default.aspx



# Statistical methods

The methods used in the statistical analyses are detailed in this section. First a Generalized Estimating Equations (GEE) and latter a Generalized Linear Mixed Model. An exploratory data analysis was performed before those regression methods.

## GEE
\label{subsec:method_GEE}

The response variable was the binary PCV to detect healthy and unhelathy cows. As we wanted to estimate the effect of dose in healthy/unhelathy cows, these two variables were included in the model.

From this initial model, a forward step-wise method was carried for the model selection, including additional covariates or interactions between them. The models were compared quasilikelihood ratio test when nested and with QuasiLikelihood Information Criteria (Pan 2001) when non-nested.

A classification table with predicted values and original data was created to asses how the model performed. Sensitivity and specificity are calculated for the final model.

## GLMM

TODO(Mathieu)

IN order to take into account the specific effect due to the cow itself we had to introduce random effects in our model. To do that we performed a Generalised Linear Mixed Model. We kept the fixed effects found in the previous part and add random effects on the intercept and the time. Since we have two way of grouping our data we have a random effect for the id and among the values of a given cow we have random effects for the kind of dose that was used. 


## Transition Models

TODO(Lluis): Add model information.
TODO(All): Include pros/cons with our data. Decide if our data could be modeled using this kinds of models.

# Results

## GEE 

TODO(Mathieu): Revise text. 

As explained in the section \ref{subsec:method_GEE}, a starting model for PCV was fitted with dose. Following a step-wise aproach time was included in the model. The number of births and its interaction with time or dose did not imporved the model. Neither it did to include the interaction between time and dose.

The final model was:

$$logit(p) = \beta_{0} + \beta_{1}time + \beta_2 doseMedium + \beta_3 doseHigh$$

Several working correlation matrices were used and an AR1$(\alpha =  0.171)$ was chosen because of its smaller QIC.

Table X shows the coefficient estimate for the final model. The odds ratio of having a high dosage is $exp(3.382)$ times of having Low dosage adjusted for time covariate. An increase of one unit in time increases the odds ratio by $exp(3.205)$ times adjusted for dose covariate. Even medium dose was not significant in the model, we keept with it in the model because High dose was significant. As part of a further research \ref{sec:Further_research} is let the models with Low and Medium dose categories merged as a single category.

TODO(Gerard): Create table with coefficients and alpha

```{r geeglm}
library("geepack")
cows.com <- cows.com %>% arrange(idDose) # Package demands to be ordered
model01ar1 <- geeglm(pcv.b ~ dose + time, id = idDose, data = cows.com,
                 family = binomial, corstr = "ar1", scale.fix = TRUE)

summary(model01ar1)
# geeglm(formula = pcv.b ~ dose + time, family = binomial, data = cows.com, 
#     id = idDose, corstr = "ar1", scale.fix = TRUE)
# 
#  Coefficients:
#             Estimate Std.err  Wald Pr(>|W|)    
# (Intercept)   -8.523   1.798 22.48  2.1e-06 ***
# doseM          1.199   1.222  0.96   0.3266    
# doseH          3.382   1.187  8.11   0.0044 ** 
# time           3.205   0.629 25.97  3.5e-07 ***
# ---
# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# 
# Scale is fixed.
# 
# Correlation: Structure = ar1  Link = identity 
# 
# Estimated Correlation Parameters:
#       Estimate Std.err
# alpha    0.171  0.0413
# Number of clusters:   29   Maximum cluster size: 3 
```


Table X shows classification table for the choosed model. The model has a sensitivity of 0.911 and a specificity of 0.839.

TODO(Gerard): Create table with classification

```{r classifcation_GEE}
pred.bin <- function(model){
  
  pred <- predict(model)
  p <- exp(pred)/(1 + exp(pred))
  round(p)
  
}

# library("caret")
# sensitivity(as.factor(pred.bin(model01ar1)), as.factor(cows.com$pcv.b))
# specificity(as.factor(pred.bin(model01ar1)), as.factor(cows.com$pcv.b))

table(pred.bin(model01ar1), cows.com$pcv.b)

#           Original data
#               0  1
# Prediccted 0 41  5
# Prediccted 1  4 26
```


## Random effects model

### Selection of the model

The GEE model does not take into account the particularity of each cow. In order to do so we performd a GLMM model. The first thing to know is what e will be the exact grouping factor. Our dataset provides us with two different ways of grouping our data. We have the idDose variable and the id then the dose which create a hierarchical model with two levels of random effects. In the last case we have a random effect for the cow among all the cows and a random effect for the dose among a given cow. We used the second case because the first one erases the subject specific effect and does as if we have 29 cows instead of only 10. 

First we tried to have random intercept on both the intercept and the time but the model did not converge so we decided to take out the random effect on the intercept. This decision was also motivated by the fact that at the beginning all the cows are sick and we are not interested in the differences between them before the treatment but in the differences in their response to the treatment. The aim of this study is to assess the efficiency of the treatment so it is of a crucial importance to add random effects for the intercept. The random effects are only used for the time covariate. It is impossible to have random effects on the dose since we would have too many parameters to estimate ragarding the number of observations. 

Now that we know where to put random effects we can start building the model with the fixed effects. We start with the covariates used in the GEE model taht is to say with fixed effeects on the dose and on the time. We have the following model:

  $$PCV.b_{i} = \beta_{0} + (\beta_{1} + b_{1i})time + \beta_2 doseMedium + \beta_3 doseHigh + \epsilon_{i}$$

Then we tried to add a fixed effect on *nbirth* and on the interaction between *time* and *dose*. Table \ref{anovas:Random_slope} gives the results of the tests we performed to know which model was the best.

\begin{table}[H]
\centering
\begin{tabular}{rrrrr}
  \hline
 & df & AIC & p-value \\ 
  \hline
$\beta_{0} + + (\beta_{1} + b_{1i})time + \beta_2 doseMedium + \beta_3 doseHigh$ & 6 & 36.592  &  \\ 
 $\beta_{0} +  + (\beta_{1} + b_{1i})time + \beta_2 doseMedium + \beta_3 doseHigh + \beta_4 nbirth$ & 7 & 38.335 & 0.6123 \\ 
 $\beta_{0} +  (\beta_{1} + b_{1i})time + \beta_2 doseMedium + \beta_3 doseHigh + \beta_4 dose*time$ & 8 & 38.998 & 0.4506 \\  
   \hline
\end{tabular}
\caption{Anova table comparing the different models with the one with fixed effects for time and dose.} 
\label{anovas:Random_slope}
\end{table}

As a result we kept the initial model. Adding random effects on *nbirth* does not make sense since we do not have a fixed effect on *nbirth*. Besides even when trying to add a fixed effect and a random effect on it, the model has a hard time estimating the parameters. Therefore our final model is:

  $$PCV.b_{i} = \beta_{0} + (\beta_{1} + b_{1i})time + \beta_2 doseMedium + \beta_3 doseHigh + \epsilon_{i}$$

### Interpretation of the selected model.

In table \ref{tab:OddsRatio} are presented the values of the odds ratio for the fixed effects of the model.

```{r glmer, results='asis'}

model.res.11 <- glmer(pcv.b~dose+time+(0+time|id/dose),data=cows.com,family=binomial,control=glmerControl(optimizer="bobyqa"))

finalModel <- model.res.11

orfixed <- as.table(c("intercept"=exp(coef(finalModel)$id[[1]][1]),"doseM"=exp(coef(finalModel)$id[[2]][1]),"doseH"=exp(coef(finalModel)$id[[3]][1])))

orrandom <- exp(c(coef(finalModel)$`dose:id`[[4]],coef(finalModel)$id[[4]]))

se <- sqrt(diag(vcov(finalModel)))
tab <- exp(cbind(inf = fixef(finalModel) - 1.96 * se, est = fixef(finalModel), 
             sup = fixef(finalModel) + 1.96 *se))

print(xtable(tab, caption = "Odds ratio with their confidence interval. \\label{tab:OddsRatio}"), comment = FALSE, table.placement = "H")
```

It appaers that an increase of one unit in time increases the odds ratio by 5.59e+13 which means that it is 5.59e+13 times more likely to be healthy than unhealthy when the time increases. The random effects on the time add variability to the effect of time depending on the id and on the dose. it means that cows have a different response to the treatment as regard to the time. The use of the high dose has an equivalent high impact on the probability to be healthy.

Extremly high (or low) values were obtained because there are only twice as much observations than parameters to estimates. Besides in our dataset one can notice that the zeros are mainly at time 1 and for the low dosage and the one at time 3 for the high dosage.

To conclue one could say that the more the cow receives the treatment (e.g. as time increases) the more likely it is that it will be healthy. The same relation goes for the choice of the high dosage as compared to the low dosage. Cows react in differents ways to the treatment as shown by the random effects on time.

# Missing Data Analysis

TODO(Gerard): Missing exploration, in process

\label{sec:Missing_data_analysis}

In this section, the patterns of missing data will be discussed and analyzed, in order to assess its influence in the analyses performed in previous sections.

Figure \ref{fig:nabars} and Table \ref{taula:nas} show the missing data distribution over time and for each dose. Clearly, the fact that an observation is missing is associated with the dose and the time (fisher tests p-values= 0.005 and 0.007, respectively). Actually, there are more missings in low and medium dose than in high dose, and also, there are more missings as time increases.

```{r nabars, fig.height=3, fig.width=5, fig.cap="Percentage of missings for each time and dose with respect to the whole sample. \\label{fig:nabars}", fig.pos="H"}

par(cex=0.8)
a <- barplot(table(is.na(cows$pcv.f), paste(cows$dose, cows$time, sep="_"))[2,c(4:9, 1:3)]/nrow(cows)*100, beside=T, space=c(0,0,0,1,0,0,1,0,0), xaxt="n", ylab="%")
abline(h=0)
axis(1, at=a[c(2,5,8),], paste("Dose", levels(cows$dose)), tick=F, line=1.5)
axis(1, at=a, rep(paste("T", 1:3, sep=""),3), tick=F, line=-0.5)
```

```{r taula:nas, results='asis'}
tau <- xtable(aggregate(list(Missing=is.na(cows$pcv.f), Available=!is.na(cows$pcv.f)), list(Time=cows$time, Dose=cows$dose), sum)[,c(2,1,3:4)],
              caption="Number of missings and available data in the outcome.",
              label="taula:nas")
print(tau, comment=F, include.rownames=F)
```

For all this, one could think that missings are produced because of the death or drop out of the cow for any reason. This makes sense also when looking at Figure ????: the cow with ID 5, for example, would have died (or left the study) before taking the time 3 low dose measure, and if one assumes that its sequence of doses was H-L-M, this explains the missings for the medium dose. Following this rationale, cows number 1, 2 and 4 would have died at the time 3 of dose L (their sequence would end with L, since there are no more missings); cows number 3, 8 and 10 before time 3 of the medium dose (ending with M dose) and cows with ID 6 and 9 before time 2 of the L dose.

The point in all this is that, if we think that the doses have different effects in the cows, then, the sequence of doses will affect the number of missings for a cow, introducing a huge source of bias in the data. Given that 8 of the 9 cows that have some missings have the first missing after being unhealthy, it would be logic to understand that the missings are produced because of the death or that the cow is dropped out from the study due to having too many health issues. With this assumption, the cows with worse prognostic would not have been analysed in the previous sections. Also, the missings could be understood like if the cow was not healthy, making the 

Therefore, the pattern for missings in this data (maybe more than one) is, probably, missings not at random (MNAR).







# Limitations and Further research
\label{sec:Further_research}

* Jacknife estimators for small sample better than sandwhich estimator

> Jackknife variance estimators are preferable to the sandwich estimator in case of a small number of clusters. (Højsgaard, Halekoh, Yan 2006)

* Compre a new factor L and M dose against H dose
* Perfect Separation Problem with gee

> It apeared when using a 22 PCV value threshold for healthy or unhealthy cow.

* Compare GEE model with GLMM. Coeficients and SE.

# Bibliography

TODO(Gerard): Normalize citations

* [Pan 2001, Biometrics, Akaike's Information Criterion in Generalized Estimating Equations.][]
* [Højsgaard, S., Halekoh, U. & Yan J. (2006) The R Package geepack for Generalized Estimating Equations Journal of Statistical Software, 15, 2, pp1--11][]
* [Hardin & Hilbe 2002, Generalized Estimating Equations][]
* Kamil Bartoń (2015). MuMIn: Multi-Model Inference. R package version 1.13.4.
  http://CRAN.R-project.org/package=MuMIn

[Pan 2001, Biometrics, Akaike's Information Criterion in Generalized Estimating Equations.]: http://www.jstor.org/stable/2676849?seq=2#references_tab_contents
[Højsgaard, S., Halekoh, U. & Yan J. (2006) The R Package geepack for Generalized Estimating Equations Journal of Statistical Software, 15, 2, pp1--11]: http://www.jstatsoft.org/v15/i02/paper
[Hardin & Hilbe 2002, Generalized Estimating Equations]: http://books.google.es/books/about/Generalized_Estimating_Equations.html?id=wxl7ajq8ymYC&redir_esc=y